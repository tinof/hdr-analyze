name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ github.ref_name }}
          name: HDR-Analyze Suite ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: false
          body: |
            ## HDR-Analyze Suite ${{ github.ref_name }}
            
            This release includes **three tools** for HDR video analysis and processing:
            
            ### ðŸŽ¬ Included Tools
            
            | Tool | Description |
            |------|-------------|
            | `hdr_analyzer_mvp` | HDR10+ metadata analyzer and measurement extractor |
            | `mkvdolby` | Dolby Vision metadata processor for MKV files |
            | `verifier` | Binary file verification utility |
            
            ### ðŸ“¦ Download
            
            Choose the appropriate archive for your platform:
            
            | Platform | Archive |
            |----------|---------|
            | **Windows (x64)** | `hdr-analyze-${{ github.ref_name }}-x86_64-pc-windows-msvc.zip` |
            | **macOS (Intel)** | `hdr-analyze-${{ github.ref_name }}-x86_64-apple-darwin.tar.gz` |
            | **macOS (Apple Silicon)** | `hdr-analyze-${{ github.ref_name }}-aarch64-apple-darwin.tar.gz` |
            | **Linux (x64)** | `hdr-analyze-${{ github.ref_name }}-x86_64-unknown-linux-gnu.tar.gz` |
            
            ### âš™ï¸ Prerequisites
            
            - **FFmpeg** must be installed and available in your system PATH
            
            ### ðŸš€ Quick Start
            
            ```bash
            # HDR10+ Analysis
            ./hdr_analyzer_mvp -i input.mkv -o measurements.bin
            
            # With advanced optimizer
            ./hdr_analyzer_mvp -i input.mkv -o measurements.bin --enable-optimizer
            
            # Process Dolby Vision metadata
            ./mkvdolby --help
            
            # Verify binary files
            ./verifier --help
            ```
            
            ### ðŸ“ What's New
            
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for detailed changes.
            
            ### ðŸ†˜ Support
            
            - [Report Issues](https://github.com/${{ github.repository }}/issues)
            - [Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)

  build:
    name: Build (${{ matrix.target }})
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04
            archive_name: hdr-analyze-x86_64-unknown-linux-gnu.tar.gz
          - target: x86_64-apple-darwin
            os: macos-13
            archive_name: hdr-analyze-x86_64-apple-darwin.tar.gz
          - target: aarch64-apple-darwin
            os: macos-latest
            archive_name: hdr-analyze-aarch64-apple-darwin.tar.gz
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive_name: hdr-analyze-x86_64-pc-windows-msvc.zip

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Install FFmpeg & Toolchain (Ubuntu)
        if: matrix.os == 'ubuntu-24.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential pkg-config clang lld libclang-dev \
            libavformat-dev libavcodec-dev libavutil-dev \
            libavfilter-dev libavdevice-dev libswscale-dev
          echo "BINDGEN_EXTRA_CLANG_ARGS=-I/usr/include/$(gcc -dumpmachine)" >> $GITHUB_ENV

      - name: Install FFmpeg & Toolchain (macOS Intel)
        if: matrix.os == 'macos-13'
        run: |
          brew install llvm ffmpeg pkg-config
          echo "LIBCLANG_PATH=$(brew --prefix llvm)/lib" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix ffmpeg)/lib/pkgconfig:$(brew --prefix)/lib/pkgconfig" >> $GITHUB_ENV
          echo "BINDGEN_EXTRA_CLANG_ARGS=-I$(brew --prefix)/include" >> $GITHUB_ENV

      - name: Install FFmpeg & Toolchain (macOS ARM)
        if: matrix.os == 'macos-latest'
        run: |
          brew install llvm ffmpeg pkg-config
          echo "LIBCLANG_PATH=$(brew --prefix llvm)/lib" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix ffmpeg)/lib/pkgconfig:$(brew --prefix)/lib/pkgconfig" >> $GITHUB_ENV
          echo "BINDGEN_EXTRA_CLANG_ARGS=-I$(brew --prefix)/include" >> $GITHUB_ENV

      - name: Cache vcpkg (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/cache@v4
        with:
          path: C:\vcpkg\installed
          key: ${{ runner.os }}-vcpkg-ffmpeg-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-ffmpeg-

      - name: Install FFmpeg & Toolchain (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install -y llvm
          & "$env:VCPKG_INSTALLATION_ROOT\vcpkg.exe" install ffmpeg:x64-windows
          echo "LIBCLANG_PATH=C:\\Program Files\\LLVM\\bin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "PKG_CONFIG_PATH=$env:VCPKG_INSTALLATION_ROOT\\installed\\x64-windows\\lib\\pkgconfig" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build All Binaries
        run: cargo build --verbose --release --workspace --target ${{ matrix.target }}

      - name: Build Archive (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          # Create staging directory
          staging="hdr-analyze-${{ github.ref_name }}-${{ matrix.target }}"
          mkdir -p "$staging/bin"
          
          # Copy all binaries
          cp "target/${{ matrix.target }}/release/hdr_analyzer_mvp" "$staging/bin/"
          cp "target/${{ matrix.target }}/release/mkvdolby" "$staging/bin/"
          cp "target/${{ matrix.target }}/release/verifier" "$staging/bin/"
          
          # Copy documentation
          cp README.md "$staging/" 2>/dev/null || echo "README not found"
          cp CHANGELOG.md "$staging/" 2>/dev/null || echo "CHANGELOG not found"
          cp LICENSE "$staging/" 2>/dev/null || echo "LICENSE not found"
          
          # Create archive
          tar czf "${{ matrix.archive_name }}" "$staging"
          echo "ASSET=${{ matrix.archive_name }}" >> $GITHUB_ENV

      - name: Build Archive (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          # Create staging directory
          staging="hdr-analyze-${{ github.ref_name }}-${{ matrix.target }}"
          mkdir -p "$staging/bin"
          
          # Copy all binaries
          cp "target/${{ matrix.target }}/release/hdr_analyzer_mvp.exe" "$staging/bin/"
          cp "target/${{ matrix.target }}/release/mkvdolby.exe" "$staging/bin/"
          cp "target/${{ matrix.target }}/release/verifier.exe" "$staging/bin/"
          
          # Copy documentation
          cp README.md "$staging/" 2>/dev/null || echo "README not found"
          cp CHANGELOG.md "$staging/" 2>/dev/null || echo "CHANGELOG not found"
          cp LICENSE "$staging/" 2>/dev/null || echo "LICENSE not found"
          
          # Create archive
          7z a "${{ matrix.archive_name }}" "$staging"
          echo "ASSET=${{ matrix.archive_name }}" >> $GITHUB_ENV

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ github.ref_name }}
          files: ${{ env.ASSET }}

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Cache
        uses: Swatinem/rust-cache@v2

      - name: Install FFmpeg dev libs
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential pkg-config clang lld \
            libavformat-dev libavcodec-dev libavutil-dev \
            libavfilter-dev libavdevice-dev libswscale-dev

      - name: Run Tests
        run: cargo test --verbose --workspace

      - name: Run Clippy
        run: cargo clippy --workspace --release -- -D warnings

      - name: Check Formatting
        run: cargo fmt --all -- --check

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        uses: taiki-e/install-action@cargo-audit

      - name: Run Security Audit
        run: cargo audit

  update-release-notes:
    name: Update Release Notes
    needs: [create-release, build, test, security-audit]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Release with Build Status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag_name = context.ref.replace('refs/tags/', '');

            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tag_name
            });

            const updatedBody = release.body + `

            ---

            ### âœ… Build Status

            All builds completed successfully:
            - âœ… Cross-platform builds (Windows, macOS Intel, macOS ARM, Linux)
            - âœ… All three tools built: \`hdr_analyzer_mvp\`, \`mkvdolby\`, \`verifier\`
            - âœ… Test suite passed
            - âœ… Code quality checks (clippy, formatting)
            - âœ… Security audit passed

            ### ðŸ“‹ Archive Contents

            Each archive contains:
            \`\`\`
            hdr-analyze-${tag_name}-<platform>/
            â”œâ”€â”€ bin/
            â”‚   â”œâ”€â”€ hdr_analyzer_mvp
            â”‚   â”œâ”€â”€ mkvdolby
            â”‚   â””â”€â”€ verifier
            â”œâ”€â”€ README.md
            â”œâ”€â”€ CHANGELOG.md
            â””â”€â”€ LICENSE
            \`\`\`

            ### ðŸ” Verification

            After downloading, verify the binaries:
            \`\`\`bash
            ./bin/hdr_analyzer_mvp --help
            ./bin/mkvdolby --help
            ./bin/verifier --help
            \`\`\`
            `;

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: updatedBody
            });

  notify-completion:
    name: Notify Release Completion
    needs: [create-release, build, test, security-audit, update-release-notes]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Release Status Summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build** | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tests** | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Security Audit** | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Included Tools" >> $GITHUB_STEP_SUMMARY
          echo "- \`hdr_analyzer_mvp\` - HDR10+ analyzer" >> $GITHUB_STEP_SUMMARY
          echo "- \`mkvdolby\` - Dolby Vision processor" >> $GITHUB_STEP_SUMMARY
          echo "- \`verifier\` - Binary verifier" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Download**: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
